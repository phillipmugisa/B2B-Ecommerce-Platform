{% extends '../utils/layout.html' %}
{% load static %}
{% load i18n %}
{% block content %}

<!-- Load the client component. -->
<script src="https://js.braintreegateway.com/web/3.87.0/js/client.min.js"></script>

<!-- Load the PayPal Checkout component. -->
<script src="https://js.braintreegateway.com/web/3.87.0/js/paypal-checkout.min.js"></script>

<!-- Load the PayPal JS SDK with your PayPal Client ID-->
<script src="https://www.paypal.com/sdk/js?client-id=AelDAnOLlL0DWcERzycpVmzfGLGWivz0wVofzAvEnY_4UxzFXSNz157E3ITiZOxG6ZhD6ilj4GF_W-cj"></script>

<!-- cards -->
<script src="https://js.braintreegateway.com/web/dropin/1.18.0/js/dropin.min.js"></script>

<!-- google pay -->
<script src="https://pay.google.com/gp/p/js/pay.js"></script>
<script src="https://js.braintreegateway.com/web/3.87.0/js/google-payment.min.js"></script>

<!-- venmo -->
<script src="https://js.braintreegateway.com/web/3.87.0/js/venmo.min.js"></script>
<script src="https://js.braintreegateway.com/web/3.87.0/js/data-collector.min.js"></script>


        
<script src="https://www.paypal.com/sdk/js?client-id=AdoY6Euji9UokT-HMy3UBZnAenKPPGA3slyR4t46b0LoZ_7sh6UB429UkKNAfCt0K4Y8Hdh1oRlJYIli&vault=true&intent=subscription" data-sdk-integration-source="button-factory"></script>

<style>
    .package {
        border: 1px solid rgb(219, 219, 219);
        cursor: pointer;
    }
    .active {
        border: none;
        outline: 2px solid hsl(38 95% 47% / 1);
        transform: scale(1.1);
    }
    .paypal-btn {
        cursor: pointer;
        background: #009cde;
        color: #fff;
        display: grid;
        place-items: center;
        padding: 0rem 2rem;
        border-radius: 5px;
    }

</style>

    <section class="grid">
        <div class="grid md:px-8 px-2 py-8 rounded auth-area w-11/12 md:w-10/12 gap-10 mx-auto my-10" style="border: 1px solid hsl(0, 0%, 95%);">
            <div class="grid gap-6">
                <h1 class="text-xl md:text-2xl font-bold text-lighterBackgroundColor">{% trans "1. Choose your Package" %}</h1>
                <hr class="border-t border-solid border-slate-200">
                <div class="plan-group grid gap-6">
                    {% for group in membership_groups %}
                    {% if group.group.group_type == "SHOWROOMS" %}
                    <div class="grid gap-4 px-4 showroom-group">
                    {% else %}
                    <div class="grid gap-4 px-4">
                    {% endif %}
                        <h1 class="text-lg md:text-xl font-semibold text-lighterBackgroundColor">{{forloop.counter}}. {{ group.group.name }}</h1>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 justify-center md:justify-start py-4 md:px-6" id="VirtualShowroomsPlans">
                            {% for plan in group.plans %}
                                <div class="package grid gap-3 p-6 md:p-8 rounded-md">
                                    <h2 class="text-lg md:text-xl font-bold text-lighterBackgroundColor">{{plan.plan.name}}</h2>
                                    <hr class="border-t border-solid border-slate-300">
                                    <div class="grid gap-2">
                                        {% for feature in plan.features %}
                                        <div class="flex gap-2">
                                            <input type="radio" name="one-showroom" id="{{feature.custom_id}}" data-price="60">
                                            <label class="text-base font-semibold" for="{{feature.custom_id}}">{{feature.price}} {{feature.currency_iso_code}} <span class="font-normal text-sm text-slate-600">{{feature.duration}}</span></label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="grid gap-4">
                <h1 class="text-xl md:text-2xl font-bold text-lighterBackgroundColor">2. Choose your Payment Method</h1>
                <hr class="border-t border-solid border-slate-200">
                <div class="grid gap-3 py-3">
                    <div class="payment-methods grid items-start justify-start">
                        <div class="flex gap-4 items-start content-start">
                            <div id="paypal-button"></div>
                            <div class="google-container"style="block-size: 70px;cursor: pointer;">
                                <span id="google-pay-button" style="block-size: 70px;">
                                    <img src="{% static 'icons/GPay.png' %}" style="inline-size: auto;block-size: 70px;" alt="g-pay">
                                </span>
                            </div>
                            <button class="paypal-btn" id="venmo-button">
                                <img style="inline-size: auto;block-size: 60px;object-fit: contain;" src="{% static 'icons/venmo.svg' %}" alt="venmo">
                            </button>
                        </div>
                        <form autocomplete="off">
                            {% if braintree_error %}
                            <div class="alert alert-danger fade in">
                                <button class="close" data-dismiss="alert">&times;</button>
                                {{ braintree_error|safe }}
                            </div>
                            {% endif %}
                            <div class="braintree-notifications"></div>
                            <div id="braintree-dropin"></div>
                            <input style="background-color: #0783ca;color: white;cursor: pointer;" id="braintree-submit-button" class="btn btn-success btn-lg btn-block" type="button" value="Pay now!" style="cursor: pointer;" />
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            var selectedPlanids = [];
            var braintree_client_token = "{{ braintree_client_token }}";
            var card_pay_button = document.querySelector('#braintree-submit-button');
            card_pay_button.disabled = true;

            const packages = document.querySelectorAll(".package");
            packages.forEach(package => {
                package.addEventListener('click', (e) => {
                    let selectedPlan = e.target.classList.contains('package') ? e.target : e.target.closest('.package');

                    let showroom_plans = document.querySelectorAll(".showroom-group .package")
                    if (showroom_plans && selectedPlan.closest(".showroom-group")) {
                        showroom_plans.forEach(_plan => {
                            if (_plan.classList.contains('active')) _plan.classList.remove('active');
                        })
                    }
                    selectedPlan.classList.add('active');
                    
                    let inputs = document.querySelectorAll(".package.active input[type='radio']:checked")
                    if (inputs.length <= 0) {
                        card_pay_button.disabled = true;
                    }
                    else {
                        inputs.forEach(
                            pricing => {
                                selectedPlanids.push(pricing.id)
                            }
                        )
                        card_pay_button.disabled = false;
                    }
                })
            })

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            
            function simulateWaith() {
                console.log("Waiting")
            }

            function paymentFinished() {
                // redirect
            }

            function makeCardsPayment(instance, plan_id) {
                simulateWaith()
                instance.requestPaymentMethod(function (err, payload) {
                    $.ajax({
                        type: 'POST',
                        url: '{% url "payment:init-subscription" %}',
                        data: {'paymentMethodNonce': payload.nonce,
                                'csrfmiddlewaretoken': '{{ csrf_token }}', 'method': "braintree card", "plan_id": plan_id}
                    }).done(function (result) {
                        let domain = (new URL(window.location.href));
                        window.location.href = `${domain.hostname}/profile`
                    });
                });
            }
            
            
            // CARDS
            braintree.dropin.create({
                authorization: braintree_client_token,
                container: '#braintree-dropin',
                card: {
                    cardholderName: {
                        required: false
                    }
                }
            }, function (createErr, instance) {
                card_pay_button.addEventListener('click', function () {

                    var plan_id;
                    console.log(selectedPlanids)

                    // determine how many packages while selected
                    if (selectedPlanids.length > 1) {
                        // if two, initialize one,
                        // wait for response then initialize the other

                    }
                    else {
                        // if now, initialize the one
                        makeCardsPayment(instance, selectedPlanids[0]);
                    }
                });
            });
        })

        // var g_pay_button = document.querySelector('#google-pay-button');
    
        // if (!window.PaymentRequest) {
        //     g_pay_button.parentNode.removeChild(g_pay_button);
        // }
        // else {
        //     var paymentsClient = new google.payments.api.PaymentsClient({
        //     environment: 'TEST' // Or 'PRODUCTION'
        //     });
        //     var braintree_client_token = "{{ braintree_client_token }}";
        
        //     braintree.client.create({
        //         authorization: braintree_client_token
        //         }, function (clientErr, clientInstance) {
        //         braintree.googlePayment.create({
        //             client: clientInstance,
        //             googlePayVersion: 2,
        //             googleMerchantId: '3060-9705-7230' // Optional in sandbox; if set in sandbox, this value must be a valid production Google Merchant ID
        //         }, function (googlePaymentErr, googlePaymentInstance) {
        //             paymentsClient.isReadyToPay({
        //             // see https://developers.google.com/pay/api/web/reference/object#IsReadyToPayRequest
        //             apiVersion: 2,
        //             apiVersionMinor: 0,
        //             allowedPaymentMethods: googlePaymentInstance.createPaymentDataRequest().allowedPaymentMethods,
        //             existingPaymentMethodRequired: true // Optional
        //             }).then(function(response) {
        //             if (response.result) {

        //                 let plan_id = document.querySelector(".package.active input[type='radio']:checked").id;
        //                 let plan_price = document.querySelector(".package.active input[type='radio']:checked").dataset['price']
                        
        //                 g_pay_button.addEventListener('click', function (event) {
        //                     event.preventDefault();
        
        //                     var paymentDataRequest = googlePaymentInstance.createPaymentDataRequest({
        //                         transactionInfo: {
        //                         currencyCode: 'USD',
        //                         totalPriceStatus: 'FINAL',
        //                         totalPrice: plan_price // Your amount
        //                         }
        //                     });
        
        //                     var cardPaymentMethod = paymentDataRequest.allowedPaymentMethods[0];
        //                     cardPaymentMethod.parameters.billingAddressRequired = true;
        //                     cardPaymentMethod.parameters.billingAddressParameters = {
        //                         format: 'FULL',
        //                         phoneNumberRequired: true
        //                     };
        
        //                     paymentsClient.loadPaymentData(paymentDataRequest).then(function(paymentData) {
        //                         googlePaymentInstance.parseResponse(paymentData, function (err, result) {
        //                             if (err) {
        //                                 // Handle parsing error
        //                                 console.log(err)
        //                             }
        
        //                             // Send result.nonce to your server
        //                             // result.type may be either "AndroidPayCard" or "PayPalAccount", and
        //                             // paymentData will contain the billingAddress for card payments
        //                             $.ajax({
        //                                 type: 'POST',
        //                                 url: '{% url "payment:init-subscription" %}',
        //                                 data: {'paymentMethodNonce': payload.nonce,
        //                             'csrfmiddlewaretoken': '{{ csrf_token }}', 'method': "braintree google pay", "plan_id": plan_id}
        //                             }).done(function (result) {
                                        
        //                                 let domain = (new URL(window.location.href));
        //                                 window.location.href = `${domain.hostname}/profile`
        //                             });
        //                             console.log(result)
        //                         });
        //                     }).catch(function (err) {
        //                         // Handle errors
        //                         console.log(err)
        //                     });
        //                 });
        //             }
        //             }).catch(function (err) {
        //                 // Handle errors

        //                 console.log(err)
        //             });
        //         });
        
        //         // Set up other Braintree components
        //     });
        
        // }

        // var venmoButton = document.getElementById('venmo-button');

        // // Create a client.
        // braintree.client.create({
        //     authorization: braintree_client_token
        // }, function (clientErr, clientInstance) {
        //     // Stop if there was a problem creating the client.
        //     // This could happen if there is a network error or if the authorization
        //     // is invalid.
        //     if (clientErr) {
        //         console.error('Error creating client:', clientErr);
        //         return;
        //     }

        //     var venmoButton = document.getElementById('venmo-button');

        //     braintree.venmo.create({
        //         client: clientInstance,
        //         allowDesktop: true,
        //         allowDesktopWebLogin: true, // available in v3.86.0+
        //         paymentMethodUsage: 'multi_use' // available in v3.77.0+
        //         // Add allowNewBrowserTab: false if your checkout page does not support
        //         // relaunching in a new tab when returning from the Venmo app. This can
        //         // be omitted otherwise.
        //         // allowNewBrowserTab: false
        //     }, function (venmoErr, venmoInstance) {
        //         if (venmoErr) {
        //             console.error('Error creating Venmo:', venmoErr);
        //             return;
        //         }

        //         // Verify browser support before proceeding.
        //         if (!venmoInstance.isBrowserSupported()) {
        //             console.log('Browser does not support Venmo');
        //             return;
        //         }

        //         displayVenmoButton(venmoInstance);

        //         // Check if tokenization results already exist. This occurs when your
        //         // checkout page is relaunched in a new tab. This step can be omitted
        //         // if allowNewBrowserTab is false.
        //         if (venmoInstance.hasTokenizationResult()) {
        //             venmoInstance.tokenize(function (tokenizeErr, payload) {
        //             if (err) {
        //                 handleVenmoError(tokenizeErr);
        //             } else {
        //                 handleVenmoSuccess(payload);
        //             }
        //             });
        //             return;
        //         }
        //     });

        //     function displayVenmoButton(venmoInstance) {
        //         // Assumes that venmoButton is initially display: none.
        //         venmoButton.style.display = 'block';

        //         venmoButton.addEventListener('click', function () {
        //             venmoButton.disabled = true;

        //             venmoInstance.tokenize(function (tokenizeErr, payload) {
        //             venmoButton.removeAttribute('disabled');

        //                 let plan_id = document.querySelector(".package.active input[type='radio']:checked").id;

        //                 $.ajax({
        //                     type: 'POST',
        //                     url: '{% url "payment:init-subscription" %}',
        //                     data: {'paymentMethodNonce': payload.nonce,
        //                             'csrfmiddlewaretoken': '{{ csrf_token }}', 'method': "braintree card", "plan_id": plan_id}
        //                 }).done(function (result) {
        //                     let domain = (new URL(window.location.href));
        //                     window.location.href = `${domain.hostname}/profile`
        //                 });
        //             });
        //         });
        //     }

        //     function handleVenmoError(err) {
        //     // ...
        //     }

        //     function handleVenmoSuccess(payload) {
        //     // ...
        //     }
        // });

        // // Create a client.
        // braintree.client.create({
        //     authorization: braintree_client_token
        // }).then(function (clientInstance) {
        //     // Create a PayPal Checkout component.
        //     return braintree.paypalCheckout.create({
        //         client: clientInstance
        //     });
        // }).then(function (paypalCheckoutInstance) {
        //     return paypalCheckoutInstance.loadPayPalSDK({
        //         vault: true
        //     });
        // }).then(function (paypalCheckoutInstance) {
        //     return paypal.Buttons({
        //         fundingSource: paypal.FUNDING.PAYPAL,

        //         createBillingAgreement: function () {
        //             return paypalCheckoutInstance.createPayment({
        //                 flow: 'vault', // Required
        //             });
        //         },

        //         onApprove: function (data, actions) {
        //             return paypalCheckoutInstance.tokenizePayment(data).then(function (payload) {

        //                 let plan_id = document.querySelector(".package.active input[type='radio']:checked").id;

        //                 $.ajax({
        //                     type: 'POST',
        //                     url: '{% url "payment:init-subscription" %}',
        //                     data: {'paymentMethodNonce': payload.nonce,
        //                             'csrfmiddlewaretoken': '{{ csrf_token }}', 'method': "braintree card", "plan_id": plan_id}
        //                 }).done(function (result) {
        //                     let domain = (new URL(window.location.href));
        //                     window.location.href = `${domain.hostname}/profile`
        //                 });
        //             });
        //         },

        //         onCancel: function (data) {
        //             console.log('PayPal payment canceled', JSON.stringify(data, 0, 2));
        //         },

        //         onError: function (err) {
        //             console.error('PayPal error', err);
        //         }
        //     }).render('#paypal-button');
        // }).then(function () {
        // // The PayPal button will be rendered in an html element with the ID
        // // `paypal-button`. This function will be called when the PayPal button
        // // is set up and ready to be used
        // }).catch(function (err) {
        // // Handle component creation error
        // });

    </script>

{% endblock %}